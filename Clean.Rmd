---
title: "LLM"
output: html_document
date: "2025-11-04"
---

```{r}
library(ellmer);
library(tidyverse);
library(furrr); # for parallel map
library(kableExtra);
library(jsonlite)
library(dplyr)
library(readr)
library(httr2)
library(purrr)
library(tibble)
library(stringr)
```
```{r}
ctg_studies <- read_csv("Data/ctg-studies.csv")
cancer <- read_csv("Data/cancer.csv")
```
```{r}
unique(cancer$cause)
```
```{r}
ctg100 <- head(ctg_studies, 100)
# unique(ctg100$Conditions)
```

```{r}
format_table <- function(df, max_length = 150) {
  head_df <- data.frame(df %>% head(5))
  # Function to truncate individual text entries
  truncate_text <- function(text, max_length) {
    text <- gsub("[\r\n]", "", text)
    return (
      ifelse(nchar(text) > max_length, 
             paste0(substr(text, 1, max_length), "..."), 
             text)
    )
  }
  
  # Loop over all columns that are character type and apply truncation
  for (col in colnames(head_df)) {
    if (is.character(head_df[[col]])) {
      head_df[[col]] <- sapply(head_df[[col]], truncate_text, max_length = max_length)
    }
  }
  
  # Return the modified data frame
  head_df %>%
    kbl() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"), font_size=12)
}

```

```{r}
Sys.setenv(OPENAI_API_KEY = "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")
```

## Test

```{r}
allowed_labels <- c(
  "Soft tissue and other extraosseous sarcomas",
  "Malignant neoplasm of bone and articular cartilage",
  "Neuroblastoma and other peripheral nervous cell tumors",
  "Neoplasms",
  "Esophageal cancer",
  "Eye cancer",
  "Stomach cancer",
  "Multiple myeloma",
  "Leukemia",
  "Other malignant neoplasms",
  "Other neoplasms",
  "Breast cancer",
  "Cervical cancer",
  "Uterine cancer",
  "Prostate cancer",
  "Colon and rectum cancer",
  "Lip and oral cavity cancer",
  "Nasopharynx cancer",
  "Other pharynx cancer",
  "Gallbladder and biliary tract cancer",
  "Pancreatic cancer",
  "Malignant skin melanoma",
  "Non-melanoma skin cancer",
  "Ovarian cancer",
  "Testicular cancer",
  "Kidney cancer",
  "Bladder cancer",
  "Brain and central nervous system cancer",
  "Thyroid cancer",
  "Mesothelioma",
  "Hodgkin lymphoma",
  "Non-Hodgkin lymphoma",
  "Liver cancer",
  "Larynx cancer",
  "Tracheal, bronchus, and lung cancer"
)
```
```{r}
`%||%` <- function(a, b) if (is.null(a)) b else a

chunk_vec <- function(x, size = 20) split(x, ceiling(seq_along(x) / size))
```

### Function
```{r}
llm_normalize_conditions_one <- function(
  conditions,
  labels = allowed_labels,
  model = "gpt-4.1-mini",
  batch_size = 20,
  temperature = 0
) {
  api_key <- Sys.getenv("OPENAI_API_KEY")
  if (identical(api_key, "")) stop("Set OPENAI_API_KEY via Sys.setenv().", call. = FALSE)

  strict_rules <- paste0(
   "You will map each clinical-trial condition string to EXACTLY ONE canonical cancer label.\n",
  "\nOUTPUT FORMAT\n",
  "- Return a STRICT JSON array of objects, no prose: ",
  "[{\"input\":\"<original>\",\"label\":\"<one label>\"}].\n",
  "- Preserve input order; no extra fields, no code fences.\n",
  "\nPRIORITY & TIE-BREAKS (aim to AVOID 'Other neoplasms')\n",
  "A) If any ORGAN-SITE cancer term appears, map to that organ’s label.\n",
  "B) If only GENERIC cancer context appears (e.g., 'cancer', 'solid tumor', 'metastases' with no site), use 'Neoplasms' (NOT 'Other neoplasms').\n",
  "C) If the string contains a WELL-KNOWN PRECURSOR or STRONG RISK CONDITION, map to the organ site:\n",
  "   - HPV, cervical intraepithelial neoplasia → Cervical cancer\n",
  "   - Barrett esophagus, esophageal dysplasia/stenosis → Esophageal cancer\n",
  "   - Colonic adenoma/adenomatous polyp → Colon and rectum cancer\n",
  "D) If multiple organ sites are present, choose the FIRST organ site mentioned (left-to-right).\n",
  "E) If benign/non-neoplastic but CLEARLY organ-specific and a common neoplastic context in trials (e.g., uterine leiomyoma/fibroid; adenomyosis), map to that organ’s label (e.g., 'Uterine cancer').\n",
  "F) Only use 'Other neoplasms' when: (1) there is NO organ site, NO generic cancer term, and NO recognized precursor/risk term; or (2) the entity is a non-neoplastic growth with no clear organ-site implication (e.g., ganglion cyst) AND no generic cancer context.\n",
  "\nNORMALIZATION RULES\n",
  "1) Labels must EXACTLY match one of the ALLOWED LABELS (case, spaces, punctuation).\n",
  "2) Histology/behavior/stage descriptors (e.g., NSCLC, metastatic, AJCC, adenocarcinoma, squamous) do NOT change organ site.\n",
  "3) 'Hematologic neoplasms' → Leukemia (unless Hodgkin or Non-Hodgkin explicitly appears).\n",
  "4) 'Spinal tumor'/'spinal cord' → Brain and central nervous system cancer.\n",
  "5) Smoking/tobacco exposure with cancer context but no site → Tracheal, bronchus, and lung cancer.\n",
  "6) Bone metastases as the primary focus of treatment/outcome → Malignant neoplasm of bone and articular cartilage.\n",
  "\nKEYWORD → LABEL LEXICON (non-exhaustive; use when present)\n",
  "- lung, bronch, trachea, nsclc, sclc → Tracheal, bronchus, and lung cancer\n",
  "- colon, colorectal, rectum, crc, polyp, adenoma → Colon and rectum cancer\n",
  "- gastric, stomach → Stomach cancer\n",
  "- liver, hcc, hepatocellular → Liver cancer\n",
  "- pancreas, pancreatic → Pancreatic cancer\n",
  "- cervix, cervical, hpv, cin → Cervical cancer\n",
  "- ovary, ovarian, pcos → Ovarian cancer\n",
  "- uterus, uterine, endometrial, fibroid, leiomyoma, adenomyosis → Uterine cancer\n",
  "- prostate, androgen, castration-resistant → Prostate cancer\n",
  "- breast, mammary → Breast cancer\n",
  "- esophag, barrett → Esophageal cancer\n",
  "- thyroid → Thyroid cancer\n",
  "- kidney, renal → Kidney cancer\n",
  "- bladder, urothelial → Bladder cancer\n",
  "- brain, cns, spinal, glioblast → Brain and central nervous system cancer\n",
  "- bone, osteosarcoma → Malignant neoplasm of bone and articular cartilage\n",
  "- melanoma → Malignant skin melanoma; basal cell/squamous cell of skin → Non-melanoma skin cancer\n",
  "- hodgkin → Hodgkin lymphoma; non-hodgkin, nhl → Non-Hodgkin lymphoma\n",
  "- myeloma → Multiple myeloma\n",
  "- sarcoma (soft tissue) → Soft tissue and other extraosseous sarcomas\n",
  "- mesothelioma → Mesothelioma\n",
  "- nasopharynx → Nasopharynx cancer; larynx → Larynx cancer; oral cavity/lip → Lip and oral cavity cancer\n",
  "- gallbladder, biliary → Gallbladder and biliary tract cancer\n",
  "- testis, testicular → Testicular cancer; eye → Eye cancer; thyroid → Thyroid cancer\n",
  "\nFINAL FALLBACK\n",
  "- If none of the above applies and there is no generic cancer context, return 'Other neoplasms'.\n",
  "\nCONSTRAINTS\n",
  "- EXACTLY ONE label per input; label must be one of the ALLOWED LABELS.\n"
  )

 system_prompt <- paste0(
  strict_rules,
  "\nALLOWED LABELS:\n- ",
  paste(allowed_labels, collapse = "\n- ")
)

  # Few-shot to anchor single-label behavior
fewshot_user <- paste0(
  "Map to EXACTLY ONE allowed label:\n",
  "- \"Human Papillomavirus Infections\"\n",
  "- \"Barrett Esophagus | Esophageal Stenosis\"\n",
  "- \"Spinal Tumors, Trauma Patients, Minocycline.\"\n",
  "- \"Treatment of Bone Metastases\"\n",
  "- \"Upper Extremity Deep Vein Thrombosis | Central Venous Catheter Thrombosis | Cancer\"\n",
  "- \"Uterine Myoma, Ovary Neoplasm, Adenomyosis\"\n",
  "- \"Tobacco Smoking\"\n",
  "- \"Hematologic Neoplasms\"\n"
)

fewshot_assistant <- jsonlite::toJSON(list(
  list(input="Human Papillomavirus Infections", label="Cervical cancer"),
  list(input="Barrett Esophagus | Esophageal Stenosis", label="Esophageal cancer"),
  list(input="Spinal Tumors, Trauma Patients, Minocycline.", label="Brain and central nervous system cancer"),
  list(input="Treatment of Bone Metastases", label="Malignant neoplasm of bone and articular cartilage"),
  list(input="Upper Extremity Deep Vein Thrombosis | Central Venous Catheter Thrombosis | Cancer", label="Neoplasms"),
  list(input="Uterine Myoma, Ovary Neoplasm, Adenomyosis", label="Uterine cancer"),
  list(input="Tobacco Smoking", label="Tracheal, bronchus, and lung cancer"),
  list(input="Hematologic Neoplasms", label="Leukemia")
), auto_unbox = TRUE)

  batches <- chunk_vec(conditions, batch_size)

  results <- vector("list", length(conditions))
  names(results) <- seq_along(conditions)
  idx_offset <- 0L

  for (b in batches) {
    idxs <- seq_along(b) + idx_offset
    idx_offset <- idx_offset + length(b)

    user_payload <- list(
      inputs = unname(as.character(b)),
      note = "Return STRICT JSON only; no prose."
    )

    req <- request("https://api.openai.com/v1/chat/completions") |>
      req_headers(
        Authorization = paste("Bearer", api_key),
        `Content-Type` = "application/json"
      ) |>
      req_body_json(list(
        model = model,
        temperature = temperature,
        messages = list(
          list(role = "system", content = system_prompt),
          list(role = "user", content = fewshot_user),
          list(role = "assistant", content = fewshot_assistant),
          list(role = "user", content =
                paste0("Map these inputs (STRICT JSON array only):\n",
                       toJSON(user_payload, auto_unbox = TRUE)))
        )
      ))

    resp <- req_perform(req)
    txt  <- resp_body_string(resp)
    txt_clean <- str_replace_all(txt, "^\\s*```(json)?\\s*|\\s*```\\s*$", "")

    parsed <- tryCatch(jsonlite::fromJSON(txt_clean, simplifyVector = FALSE), error = function(e) NULL)

    # If we got the usual chat envelope, extract content
    if (is.null(parsed) || !is.null(parsed$choices)) {
      content <- parsed$choices[[1]]$message$content
      content <- str_replace_all(content, "^\\s*```(json)?\\s*|\\s*```\\s*$", "")
      parsed  <- tryCatch(jsonlite::fromJSON(content, simplifyVector = FALSE), error = function(e) NULL)
    }

    if (is.null(parsed) || !is.list(parsed)) {
      stop("LLM did not return valid JSON. Raw text:\n", txt)
    }

    for (j in seq_along(parsed)) {
      item <- parsed[[j]]
      lab  <- as.character(item$label %||% NA)

      # Guardrail: keep only allowed, else fallback
      if (!(lab %in% labels)) lab <- "Other neoplasms"

      i_global <- idxs[j]
      results[[as.character(i_global)]] <- list(
        input = as.character(conditions[i_global] %||% NA),
        label = lab
      )
    }
  }

  tibble::tibble(
    row = seq_along(conditions),
    input = conditions,
    Condition_clean = map_chr(results, ~ .x$label %||% "Other neoplasms")
  )
}
```

### Apply
```{r}
clean_map <- llm_normalize_conditions_one(ctg100$Conditions)
ctg100_clean <- ctg100 %>%
  mutate(Condition_clean = clean_map$Condition_clean) %>%
  select(Conditions, Condition_clean)

unique(ctg100_clean$Condition_clean)
clean_map
ctg100_clean_filtered <- ctg100_clean %>%
  filter(Condition_clean == "Other neoplasms")
unique(ctg100_clean_filtered$Conditions)
#unique(ctg100_clean$Conditions)
```

```{r}
print(ctg100_clean[, c("Conditions", "Conditions_clean")], n = 20)
```
```{r}
ctg100_clean %>%
  select(Conditions, Conditions_clean) %>%
  head(100) %>%  # show first 20 rows
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

